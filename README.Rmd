---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# sspm <img src='man/figures/logo.png' align="right" height="150" />

<!-- badges: start -->
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT/)
[![R-CMD-check](https://github.com/pedersen-fisheries-lab/sspm/workflows/R-CMD-check/badge.svg)](https://github.com/pedersen-fisheries-lab/sspm/actions)
[![Codecov test coverage](https://codecov.io/gh/pedersen-fisheries-lab/sspm/branch/main/graph/badge.svg)](https://codecov.io/gh/pedersen-fisheries-lab/sspm?branch=main)
<!-- [![Downloads](https://cranlogs.r-pkg.org/badges/sspm?color=brightgreen)](https://CRAN.R-project.org/package=sspm/)
[![Latest Release](https://img.shields.io/github/v/release/pedersen-fisheries-lab/sspm?label=Latest%20Release)](https://github.com/pedersen-fisheries-lab/sspm/releases/latest)
[![CRAN Version](https://img.shields.io/cran/v/sspm?label=CRAN%20Version)](https://CRAN.R-project.org/package=sspm)
[![GitHub Version](https://img.shields.io/github/r-package/v/pedersen-fisheries-lab/sspm?label=GitHub%20Version)](https://github.com/pedersen-fisheries-lab/sspm/blob/dev/DESCRIPTION) -->
<!-- badges: end -->

The goal of `sspm` is to implement a gam-based spatial surplus production model, aimed at modeling northern shrimp population in Canada but potentially to any stock in any location. The package is opinionated in its implementation of SPMs as it internally makes the choice to use penalized spatial gams with time lags  based on Pedersen et al. (2020). However, it also aims to provide options for the user to customize their model.

## Installation

<!-- You can install the released version of sspm from [CRAN](https://CRAN.R-project.org) with: -->
<!-- ``` r -->
<!-- install.packages("sspm") -->
<!-- ``` -->

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("pedersen-fisheries-lab/sspm")
```

## Example

The following example shows the typical `sspm` workflow. The API is subject to changes as the package is still in development.

Let's first load the test data.

```{r}
library(sspm)
library(mgcv)

borealis <- sspm:::borealis_simulated
predator <- sspm:::predator_simulated
catch <- sspm:::catch_simulated
sfa_boundaries <- sspm:::sfa_boundaries
```

1. Start by creating a base `sapspm` object with a base dataset called "Biomass".
```{r}
sspm_base <- sspm(model_name = "My Model",
                  boundaries = sfa_boundaries) %>% 
  map_biomass(borealis, "borealis", 
              time_column = "year_f",
              coords = c('lon_dec','lat_dec'),
              uniqueID = "uniqueID")
sspm_base
```

2. Then, discretize the object using a method for discretization, the default behind voronoi tesselation. See `?spm_methods()` for the list of methods available.
```{r}
sspm_discrete <- sspm_base %>%
  spm_discretize(with_dataset = "borealis", 
                 discretization_method = "tesselate_voronoi")
sspm_discrete
```
The results of the discretization can be explored with `spm_patches()` and `spm_points()`. You can also plot the object to inspect the resulting discretization.
```{r}
spm_patches(sspm_discrete)
spm_points(sspm_discrete)
plot(sspm_discrete)
```

3. Then, other datasets may be loaded alongside the biomass dataset, for example, predator and catch data.
```{r}
sspm_mapped <- sspm_discrete %>%
  map_predictor(predator,
                name = "pred_data",
                time_column = "year",
                uniqueID = "uniqueID",
                coords = c("lon_dec", "lat_dec")) 
sspm_mapped
```

4. Smoothing formulas for any of the datasets may be specified, using special terms `smooth_time()`, `smooth_space` and `smooth_space_time`. NOTE: the testing dataset is dummy data and wont converge if `smooth_time()` or `smooth_space_time` is used (to be fixed soon).
```{r}
sspm_with_formulas <- sspm_mapped %>%
  map_formula(weight_per_km2~smooth_time() + smooth_space(), "borealis") %>% 
  map_formula(weight_per_km2~smooth_time() + smooth_space(), "pred_data")
sspm_with_formulas
```

5. Finally, formulas can be fitted with `fit_smooths()`
```{r}
sspm_smooth_fitted <- sspm_with_formulas %>%
  fit_smooths()
sspm_smooth_fitted
```

The smoothed results for any smoothed variables (listed in "smoothed vars" above) can be plotted:
```{r}
plot(sspm_smooth_fitted, smoothed_var = "pred_data_smooth")
```

6. We also need to register catch data.  For catch data, it is important to precise a data column which will be aggregated at the `patch_id` level.
```{r}
sspm_smooth_fitted_wcatch <-  sspm_smooth_fitted %>% 
  map_catch(catch, name = "catch_data", 
            time_column = "year_f", 
            uniqueID = "uniqueID", 
            coords = c("lon_start", "lat_start"), 
            catch_column = "catch", 
            biomass_column = "borealis_smooth")
sspm_smooth_fitted_wcatch
```

7. To fit the final SPM, we might need to add lagged values. This is easily done with `spm_lag`.
```{r}
sspm_smooth_fitted_wcatch_lagged <- sspm_smooth_fitted_wcatch %>% 
  spm_lag(c("borealis_smooth", "pred_data_smooth"), 1)
sspm_smooth_fitted_wcatch_lagged
```

8. Before fitting the model, we split data into test/train.
```{r}
sspm_smooth_fitted_wcatch_lagged <-
  spm_split(sspm_smooth_fitted_wcatch_lagged, year_f %in% c(1996:2000))
sspm_smooth_fitted_wcatch_lagged
```

9. We can now map a final spm formula onto the smoothed data
```{r}
sspm_smooth_with_formulas <- sspm_smooth_fitted_wcatch_lagged %>% 
  map_formula(borealis_smooth_with_catch ~ pred_data_smooth_lag_1 + smooth_lag("borealis_smooth_with_catch"))
sspm_smooth_with_formulas
```

10. We can now fit the SPM. 
```{r, eval = TRUE}
sspm_with_fit <- 
  sspm_smooth_with_formulas %>% fit_spm()
sspm_with_fit
```
```{r}
spm_smoothed_fit(spm_smoothed_data(sspm_with_fit))
```

11. We can also extract predictions.
```{r}
# TODO
```
